<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Chat</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b141a; color:#e9edef; }
    .app { max-width: 760px; margin: 0 auto; height: 100vh; display:flex; flex-direction: column; }
    .topbar { padding: 12px 14px; background:#111b21; display:flex; gap:10px; align-items:center; border-bottom: 1px solid #1f2c33;}
    .dot { width:10px; height:10px; border-radius:50%; background:#2dd36f; }
    .title { font-weight: 650; }
    .sub { font-size: 12px; opacity: .75; }

    .chat { flex:1; overflow:auto; padding: 14px; background: #0b141a; }
    .msgrow { display:flex; margin: 6px 0; }
    .msgrow.me { justify-content: flex-end; }
    .bubble { max-width: 78%; padding: 10px 10px 7px; border-radius: 14px; line-height:1.25; position: relative; }
    .me .bubble { background:#005c4b; border-top-right-radius: 6px; }
    .other .bubble { background:#1f2c33; border-top-left-radius: 6px; }

    .meta { margin-top: 6px; font-size: 11px; opacity: .75; display:flex; gap: 8px; justify-content: flex-end; }
    .other .meta { justify-content: space-between; }
    .user { font-weight: 650; opacity:.9; }
    .sys { opacity:.7; font-size: 12px; text-align:center; margin: 10px 0; }

    .composer { padding: 10px; background:#111b21; border-top: 1px solid #1f2c33; display:flex; gap:10px; }
    input, button { border:0; outline: none; }
    #msg { flex:1; background:#1f2c33; color:#e9edef; border-radius: 999px; padding: 12px 14px; }
    button { background:#2dd36f; color:#031b12; padding: 10px 14px; border-radius: 999px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .login { padding: 10px 14px; background:#0b141a; border-bottom:1px solid #1f2c33; display:flex; gap:10px; flex-wrap: wrap; }
    .login input { background:#1f2c33; color:#e9edef; border-radius: 999px; padding: 10px 12px; }
    #status { font-size: 12px; opacity:.8; padding: 8px 14px; background:#0b141a; border-bottom:1px solid #1f2c33; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="dot"></div>
      <div>
        <div class="title">Live Chat</div>
        <div class="sub">GitHub Pages + Google Sheets</div>
      </div>
    </div>

    <div class="login">
      <input id="user" placeholder="User ID (e.g. iskandar)" maxlength="30">
      <input id="pw" placeholder="Chat Password" type="password">
      <input id="room" placeholder="Room (default: main)" value="main" maxlength="20">
      <button id="save">Save</button>
    </div>

    <div id="status">Not connected yet.</div>

    <div id="chat" class="chat"></div>

    <div class="composer">
      <input id="msg" placeholder="Type a message…" autocomplete="off">
      <button id="send">Send</button>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztQ8U_u7daQ5Uy84-Xad_ddzHNwJ1SHteoyniNH1iieMkIjjcEHgsGGf2uA6pObokLwQ/exec";

  const elChat = document.getElementById("chat");
  const elMsg = document.getElementById("msg");
  const elUser = document.getElementById("user");
  const elPw = document.getElementById("pw");
  const elRoom = document.getElementById("room");
  const elStatus = document.getElementById("status");
  const elSend = document.getElementById("send");
  const elSave = document.getElementById("save");

  let state = {
    user: localStorage.getItem("chat_user") || "",
    pw: localStorage.getItem("chat_pw") || "",
    room: localStorage.getItem("chat_room") || "main",
    after: 0,
    polling: null,
    lastRenderTs: 0
  };

  elUser.value = state.user;
  elPw.value = state.pw;
  elRoom.value = state.room;

  function fmtTime(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function setStatus(text) {
    elStatus.textContent = text;
  }

  function shouldAutoScroll() {
    const threshold = 140; // px
    return (elChat.scrollHeight - elChat.scrollTop - elChat.clientHeight) < threshold;
  }

  function scrollToBottom() {
    elChat.scrollTop = elChat.scrollHeight;
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function renderMessage(m) {
    const isMe = m.user === state.user;
    const row = document.createElement("div");
    row.className = "msgrow " + (isMe ? "me" : "other");

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const msgText = document.createElement("div");
    msgText.innerHTML = escapeHtml(m.message).replace(/\n/g, "<br>");
    bubble.appendChild(msgText);

    const meta = document.createElement("div");
    meta.className = "meta";
    if (!isMe) {
      const userSpan = document.createElement("span");
      userSpan.className = "user";
      userSpan.textContent = m.user;
      meta.appendChild(userSpan);
    } else {
      const spacer = document.createElement("span");
      spacer.textContent = "";
      meta.appendChild(spacer);
    }

    const timeSpan = document.createElement("span");
    timeSpan.textContent = fmtTime(m.ts);
    meta.appendChild(timeSpan);

    bubble.appendChild(meta);
    row.appendChild(bubble);
    elChat.appendChild(row);
  }

  async function apiGetMessages() {
    const qs = new URLSearchParams({
      room: state.room || "main",
      after: String(state.after || 0),
      limit: "120",
      pw: state.pw,
      user: state.user
    });

    const res = await fetch(`${SCRIPT_URL}?${qs.toString()}`, { method: "GET" });
    const data = await res.json();
    return data;
  }

  async function apiSendMessage(text) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        room: state.room || "main",
        user: state.user,
        pw: state.pw,
        message: text
      })
    });
    const data = await res.json();
    return data;
  }

  async function poll() {
    if (!state.user || !state.pw) {
      setStatus("Enter User ID + Password, then Save.");
      return;
    }

    try {
      const auto = shouldAutoScroll();

      const data = await apiGetMessages();
      if (!data.ok) {
        setStatus("Error: " + data.error);
        return;
      }

      if (data.messages.length) {
        for (const m of data.messages) {
          renderMessage(m);
          state.after = Math.max(state.after, m.ts);
        }
        if (auto) scrollToBottom();
      }

      setStatus(`Connected • Room: ${state.room} • Last: ${state.after ? fmtTime(state.after) : "—"}`);
    } catch (e) {
      setStatus("Network error. Check SCRIPT_URL and deployment access.");
    }
  }

  async function send() {
    const text = elMsg.value.trim();
    if (!text) return;

    if (!state.user || !state.pw) {
      setStatus("Please Save User ID + Password first.");
      return;
    }

    elSend.disabled = true;
    try {
      const data = await apiSendMessage(text);
      if (!data.ok) {
        setStatus("Send failed: " + data.error);
      } else {
        elMsg.value = "";
        await poll(); // refresh quickly
      }
    } catch (e) {
      setStatus("Send failed: network error.");
    } finally {
      elSend.disabled = false;
      elMsg.focus();
    }
  }

  elSave.addEventListener("click", () => {
    state.user = elUser.value.trim();
    state.pw = elPw.value.trim();
    state.room = (elRoom.value.trim() || "main");

    localStorage.setItem("chat_user", state.user);
    localStorage.setItem("chat_pw", state.pw);
    localStorage.setItem("chat_room", state.room);

    elChat.innerHTML = "";
    state.after = 0;

    setStatus("Saved. Connecting…");
    poll();

    if (state.polling) clearInterval(state.polling);
    state.polling = setInterval(poll, 2000);
  });

  elSend.addEventListener("click", send);
  elMsg.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // auto-start polling if credentials exist
  if (state.user && state.pw) {
    setStatus("Connecting…");
    poll();
    state.polling = setInterval(poll, 2000);
  } else {
    setStatus("Enter User ID + Password, then Save.");
  }
</script>
</body>
</html>
